---
title: "Análisis No Paramétricos"
author: "Arturo Bell Enríquez García"
output: html_notebook
---

```{r}
# Tema personalizado
blank_theme <- function(){
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.background = element_blank(),
        axis.line = element_blank(),
        aspect.ratio = 1/1.61,
        axis.ticks = element_blank(),
        text = element_text(colour = "gray50"), # Eliminar
        legend.position = "none"
        )
}
```

En esta sesión utilizaremos los archivos `Datos1.csv`, `Datos_bloques.csv` y `Abundancias.csv`, por lo que primero tendremos que cargarlos:

```{r}
# Carga de datos
df <- read.csv("Datos1.csv", header = F, skip = 1, sep = ",")
colnames(df) <- c("Dieta", "Periodo", "Rep", "LT", "PT")
head(df)
```

```{r}
bloques <- read.csv("Datos_bloques.csv")
head(bloques)
```

```{r}
abundancias <- read.csv("Abundancias.csv") #file.chose()
abundancias
```


Comencemos entonces a explorar algunas de las distintas herramientas que tenemos a nuestra disposición:

## Comparación de muestras independientes: U de Mann-Whitney

Para aplicarla en R utilizaremos la función `wilcox.test(formula)`, pero primero exploremos nuestros datos.
Nuestra variable de interés es la variable LT, por lo que realizaremos la evaluación de la normalidad, tanto de manera cuantitativa (prueba de Shapiro-Wilks, sesgo y curtosis), como de manera gráfica (Gráficos de densidad).

```{r}

library(moments)
norms <- data.frame(Dieta = NA, w = NA, p = NA, k = NA, s = NA)

grupos <- unique(df$Dieta)

for (i in 1:length(grupos)) {
  st <- shapiro.test(df$LT[df$Dieta == grupos[i]])
  
  norms[i,] <- c(as.character(grupos[i]), 
                 round(st[["statistic"]], 2), 
                 round(st[["p.value"]], 3),
                 round(kurtosis(df$LT[df$Dieta == grupos[i]]), 2),
                 round(skewness(df$LT[df$Dieta == grupos[i]]),2)
                 )
}

norms
```

```{r}
library(ggplot2)
kdeplots <- ggplot(data = df, aes(LT, color = Dieta)) + 
            geom_density() + 
            facet_wrap(~Dieta, nrow = 2) + 
            blank_theme() +
            labs(title = "Longitud Total de Guppys bajo tres dietas",
                 subtitle = "Gráficos de densidad",
                 caption = "Archivo: Datos1.csv",
                 x = element_blank(),
                 y = element_blank()) +
            scale_y_continuous(breaks = NULL)
kdeplots
```

Imaginemos que nos interesa conocer si los organismos alimentados con la dieta B tuvieron una longitud total diferente a los alimentados con la dieta C, entonces apliquemos una prueba U-Mann-Whitney.

```{r}
u.data <- subset(df, Dieta != "A")
wilcox.test(LT~Dieta, data = u.data)
```

Este resultado corresponde bastante bien con lo visto en los gráficos de densidad en el sentido de falta de diferencias, aunque podemos representarlo utilizando un gráfico de violín que es más adecuado para propósitos de comparación:
```{r}
u.mann.plot <- ggplot(data = u.data, aes(x = Dieta, y = LT, fill = Dieta)) + 
               geom_violin(trim = T, alpha = 0.7) + 
               geom_boxplot(width = 0.1, fill = "white", notch = T) + 
               blank_theme() +
               labs(title = "Comparación de la longitud total de guppys bajo las dietas B y C",
                    subtitle = "Gráficos de violín con gráficos de cajas y bigotes superpuestos",
                    caption = "Archivo: Datos1.csv",
                    x = element_blank(),
                    y = element_blank()
                    ) +
               scale_fill_manual(values = c(rgb(29,149,79, maxColorValue = 255),
                                            rgb(126,172,255, maxColorValue = 255))
                                 )
u.mann.plot
```

### Comparación de dos muestras dependientes (pareadas): Prueba por rangos de Wilcoxon

Otra pregunta que podemos estar interesados en responder con esta base de datos es si las Longitudes Totales al inicio del experimento fueron iguales o diferentes al final del experimento en la dieta A y asumamos, **para fines de enseñanza**, a) que los datos a este nivel no siguen una distribución normal y b) que tenemos mediciones pareadas; es decir, que la medición 1 del periodo inicial corresponde al mismo individuo que la medición 1 del periodo final. Bajo estos supuestos, realizaremos la prueba de rangos de Wilcoxon.

En r, por fortuna, la implementación es sencilla, solo hay que considerar que al ser una prueba pareada, el número de datos en ambos grupos debe ser igual.


```{r}
wilcox.data <- subset(df, (Dieta == "A" & Periodo != "M")) # Extraemos solo los datos que nos interesan
aggregate(LT~Periodo, data = wilcox.data, length) # Vemos que al final tenemos un individuo menos que al inicio, por lo que hay que retirarlo de la base de datos (asumamos que es el último)

wilcox.data <- wilcox.data[-c(20),]
aggregate(LT~Periodo, data = wilcox.data, length) #Ahora tenemos ns iguales, por lo que podemos aplicar la prueba pareada
```

Ahora apliquemos la prueba.
```{r}
wilcox.test(LT~Periodo, data = wilcox.data, paired = T)
```

Vemos que al parecer las medianas son diferentes, lo cual se sostiene al analizar los resultados de manera gráfica:
```{r}
w.rank.plot <- ggplot(data = wilcox.data, aes(x = Periodo, y = LT, fill = Periodo)) + 
               geom_violin(trim = T, alpha = 0.7) + 
               geom_boxplot(width = 0.1, fill = "white", notch = T) + 
               blank_theme() +
               labs(title = "Comparación de la longitud total de guppys bajo las dietas B y C",
                    subtitle = "Gráficos de violín con gráficos de cajas y bigotes superpuestos",
                    caption = "Archivo: Datos1.csv",
                    x = element_blank(),
                    y = element_blank()
                    ) +
               scale_fill_manual(values = c(rgb(29,149,79, maxColorValue = 255),
                                            rgb(126,172,255, maxColorValue = 255))
                                 )
w.rank.plot
```
 
## Prueba por Rangos de Friedman y coeficiente de acuerdo de Kendall

Para aplicar esta prueba es necesario cambiar el formato de la base de datos de una base de datos tabular a una base de datos codificada utilizando la función `melt(data, id.vars, variable.name, value.name)`:

```{r}
library(reshape2)
bloques.molten <- melt(bloques, id.vars = "Pez", variable.name = "Secc", value.name = "Act")
bloques.molten
```
Ahora podemos aplicar la prueba de Friedman utilizando la función `friedman.test(a ~ b|c)`, donde a representa la variable de medición, b los grupos y c los bloques. 
```{r}
friedman.test(Act~Secc|Pez, data = bloques.molten)
```
Realicemos la comparación gráficamente:
```{r}
fried.plot <- ggplot(data = bloques.molten, aes(x = Secc, y = Act, fill = Secc)) + 
              geom_violin(trim = T, alpha = 0.7) + 
              geom_boxplot(width = 0.1, fill = "white", notch = F) + 
              blank_theme() +
              labs(title = "Actividad proteolítica entre 4 secciones del tracto digestivo de peces",
                  subtitle = "Gráficos de violín con gráficos de cajas y bigotes superpuestos",
                  caption = "Archivo: Datos1.csv",
                  x = element_blank(),
                  y = element_blank()
                  )
fried.plot
```

De estos resultados podríamos concluir que no hubo diferencias entre la actividad proteolítica entre las distintas secciones de los tractos digestivos, pero ¿qué tan diferentes entre sí fueron los peces? Utilicemos el coeficiente de acuerdo de Kendall utilizando la función `KendallW(x, correct, test, na.rm)` de la librería `DescTools` donde x representa una matriz de k grupos (columnas) y m bloques (renglones), correct es un argumento booleano si se debe de realizar la corrección por empates en los rangos y test para realizar una prueba $\chi^2$ con $H_0: W = 0$; es decir, si hubo o no un desacuerdo total entre los bloques. A partir de los resultados vemos que hubo alrededor de un 18% de similitudes entre la actividad proteolítica de los peces, por lo cual los resultados de la prueba de Friedman no son confiables.

```{r}
if(!require(DescTools)) install.packages("DescTools", dependencies = T)
#library(DescTools)
KendallW(bloques, correct = T, test = T) #Esta función sí requiere los datos en forma tabular, por lo que x será nuestra variable bloques
```
Y comprobémoslo gráficamente (**ojo**, para graficar estamos utilizando la base codificada)

```{r}
kendall.plot <- ggplot(data = bloques.molten, 
                       aes(x = as.factor(Pez), y = Act, fill = as.factor(Pez))) + # OJO: Estamos transformando la columna Pez a un factor (son números)
                geom_violin(trim = T, alpha = 0.7) + 
                geom_boxplot(width = 0.1, fill = "white", notch = F) + 
                blank_theme() +
                labs(title = "Comparación de la actividad proteolítica entre 9 peces",
                    subtitle = "Gráficos de violín con gráficos de cajas y bigotes superpuestos",
                    caption = "Archivo: Datos_bloques.csv",
                    x = element_blank(),
                    y = element_blank()
                    )
kendall.plot
```

## ANOVA no paramétrico: Kruskall-Wallis y prueba de Dunn:

Primero, el ANOVA Kruskal-Wallis utilizando la función `kruskal.test(formula, data)`:

```{r}
H <- kruskal.test(LT~Dieta, data = subset(df, Periodo == "F"))
H
```
Vemos que aparentemente no hay diferencias entre las medianas; sin embargo, realicemos la prueba de Dunn para confirmar. Para ello utilizaremos la función `DunnTest(formula, data)` de la librería `DescTools`. Vemos que en efecto, pareciera no haber diferencias entre las longitudes finales de los guppys en función de las dieta con la que fueron alimentados.

```{r}
DunnTest(LT~Dieta, data = subset(df, Periodo == "F"))
```
Corroboremos esto de manera gráfica:
```{r}
kruskal.plot <- ggplot(data = subset(df, Periodo == "F"), 
                       aes(x = Dieta, y = LT, fill = Dieta)) +
                geom_violin(trim = T, alpha = 0.7) + 
                geom_boxplot(width = 0.1, fill = "white", notch = F) + 
                blank_theme() +
                labs(title = "Comparación de las longitudes totales finales de Guppys",
                    subtitle = "Gráficos de violín con gráficos de cajas y bigotes superpuestos",
                    caption = "Archivo: Datos1.csv",
                    x = element_blank(),
                    y = element_blank()
                    )
kruskal.plot
```

Con esto llegamos al final de esta clase. Espero que haya sido de tu agrado y nos vemos en la siguiente.
